<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: Homebrew::Attestation
  
    &mdash; Homebrew Ruby API
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Homebrew::Attestation";
  relpath = '../';
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../_index.html">Index (A)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../Homebrew.html" title="Homebrew (module)">Homebrew</a></span></span>
     &raquo; 
    <span class="title">Attestation</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: Homebrew::Attestation
  
  
  <span class="private note title">Private</span>
</h1>
<div class="box_info">
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>attestation.rb</dd>
  </dl>
  
</div>

<div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This module is part of a private API.</strong>
  This module may only be used in the <a href="https://github.com/Homebrew/brew">Homebrew/brew</a> repository.
  Third parties should avoid using this module if possible, as it may be removed or changed without warning.
</p>


  </div>
</div>
<div class="tags">
  

</div><h2>Defined Under Namespace</h2>
<p class="children">
  
    
  
    
      <strong class="classes">Classes:</strong> <span class='object_link'><a href="Attestation/GhAuthNeeded.html" title="Homebrew::Attestation::GhAuthNeeded (class)">GhAuthNeeded</a></span>, <span class='object_link'><a href="Attestation/InvalidAttestationError.html" title="Homebrew::Attestation::InvalidAttestationError (class)">InvalidAttestationError</a></span>
    
  
</p>

  
    <h2>
      Constant Summary
      <small><a href="#" class="constants_summary_toggle">collapse</a></small>
    </h2>

    <dl class="constants">
      
        <dt id="HOMEBREW_CORE_REPO-constant" class="">HOMEBREW_CORE_REPO =
          <div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This constant is part of a private API.</strong>
  This constant may only be used in the <a href="https://github.com/Homebrew/brew">Homebrew/brew</a> repository.
  Third parties should avoid using this constant if possible, as it may be removed or changed without warning.
</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Homebrew/homebrew-core</span><span class='tstring_end'>&quot;</span></span></pre></dd>
      
        <dt id="HOMEBREW_CORE_CI_URI-constant" class="">HOMEBREW_CORE_CI_URI =
          <div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This constant is part of a private API.</strong>
  This constant may only be used in the <a href="https://github.com/Homebrew/brew">Homebrew/brew</a> repository.
  Third parties should avoid using this constant if possible, as it may be removed or changed without warning.
</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>https://github.com/Homebrew/homebrew-core/.github/workflows/publish-commit-bottles.yml@refs/heads/master</span><span class='tstring_end'>&quot;</span></span></pre></dd>
      
        <dt id="BACKFILL_REPO-constant" class="">BACKFILL_REPO =
          <div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This constant is part of a private API.</strong>
  This constant may only be used in the <a href="https://github.com/Homebrew/brew">Homebrew/brew</a> repository.
  Third parties should avoid using this constant if possible, as it may be removed or changed without warning.
</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>trailofbits/homebrew-brew-verify</span><span class='tstring_end'>&quot;</span></span></pre></dd>
      
        <dt id="BACKFILL_CUTOFF-constant" class="">BACKFILL_CUTOFF =
          <div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This constant is part of a private API.</strong>
  This constant may only be used in the <a href="https://github.com/Homebrew/brew">Homebrew/brew</a> repository.
  Third parties should avoid using this constant if possible, as it may be removed or changed without warning.
</p>
<p>No backfill attestations after this date are considered valid.</p>

<p>This date is shortly after the backfill operation for homebrew-core
completed, as can be seen here: <a href="https://github.com/trailofbits/homebrew-brew-verify/attestations">https://github.com/trailofbits/homebrew-brew-verify/attestations</a>.</p>

<p>In effect, this means that, even if an attacker is able to compromise the backfill
signing workflow, they will be unable to convince a verifier to accept their newer,
malicious backfilled signatures.</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='const'>T</span><span class='period'>.</span><span class='id identifier rubyid_let'>let</span><span class='lparen'>(</span><span class='const'>DateTime</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='int'>2024</span><span class='comma'>,</span> <span class='int'>3</span><span class='comma'>,</span> <span class='int'>14</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_freeze'>freeze</span><span class='comma'>,</span> <span class='const'>DateTime</span><span class='rparen'>)</span></pre></dd>
      
    </dl>
  







  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        
<li class="public ">
  <span class="summary_signature">
    
      <a href="#check_attestation-class_method" title="check_attestation (class method)">.<strong>check_attestation</strong>(bottle, signing_repo, signing_workflow = nil, subject = nil)  &#x21d2; Hash{T.untyped =&gt; T.untyped} </a>
    
    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>
  
    <span class="summary_desc"><div class='inline'><p>Verifies the given bottle against a cryptographic attestation of build provenance.</p>
</div></span>
  
</li>

      
        
<li class="public ">
  <span class="summary_signature">
    
      <a href="#check_core_attestation-class_method" title="check_core_attestation (class method)">.<strong>check_core_attestation</strong>(bottle)  &#x21d2; Hash{T.untyped =&gt; T.untyped} </a>
    
    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>
  
    <span class="summary_desc"><div class='inline'><p>Verifies the given bottle against a cryptographic attestation of build provenance from homebrew-core&#39;s CI, falling back on a &quot;backfill&quot; attestation for older bottles.</p>
</div></span>
  
</li>

      
        
<li class="public ">
  <span class="summary_signature">
    
      <a href="#gh_executable-class_method" title="gh_executable (class method)">.<strong>gh_executable</strong>  &#x21d2; Pathname </a>
    
    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>
  
    <span class="summary_desc"><div class='inline'><p>Returns a path to a suitable <code>gh</code> executable for attestation verification.</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="check_attestation-class_method">
  
    .<strong>check_attestation</strong>(bottle, signing_repo, signing_workflow = nil, subject = nil)  &#x21d2; <tt><span class='object_link'><a href="../Hash.html" title="Hash (class)">Hash</a></span>{<span class='object_link'>T</span>.untyped =&gt; <span class='object_link'>T</span>.untyped}</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  This method may only be used in the <a href="https://github.com/Homebrew/brew">Homebrew/brew</a> repository.
  Third parties should avoid using this method if possible, as it may be removed or changed without warning.
</p>
<p>Verifies the given bottle against a cryptographic attestation of build provenance.</p>

<p>The provenance is verified as originating from <code>signing_repo</code>, which is a <code>String</code>
that should be formatted as a GitHub <code>owner/repo</code>.</p>

<p>Callers may additionally pass in <code>signing_workflow</code>, which will scope the attestation
down to an exact GitHub Actions workflow, in
<code>https://github/OWNER/REPO/.github/workflows/WORKFLOW.yml@REF</code> format.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>bottle</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Bottle.html" title="Bottle (class)">Bottle</a></span></tt>)</span>
      
      
      
    </li>
  
    <li>
      
        <span class='name'>signing_repo</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
    </li>
  
    <li>
      
        <span class='name'>signing_workflow</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../String.html" title="String (class)">String</a></span></tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
    </li>
  
    <li>
      
        <span class='name'>subject</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../String.html" title="String (class)">String</a></span></tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Hash.html" title="Hash (class)">Hash</a></span>{<span class='object_link'>T</span>.untyped =&gt; <span class='object_link'>T</span>.untyped}</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>the JSON-decoded response.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Attestation/GhAuthNeeded.html" title="Homebrew::Attestation::GhAuthNeeded (class)">GhAuthNeeded</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>on any authentication failures</p>
</div>
      
    </li>
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Attestation/InvalidAttestationError.html" title="Homebrew::Attestation::InvalidAttestationError (class)">InvalidAttestationError</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>on any verification failures</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'attestation.rb', line 73</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_check_attestation'>check_attestation</span><span class='lparen'>(</span><span class='id identifier rubyid_bottle'>bottle</span><span class='comma'>,</span> <span class='id identifier rubyid_signing_repo'>signing_repo</span><span class='comma'>,</span> <span class='id identifier rubyid_signing_workflow'>signing_workflow</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_subject'>subject</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_cmd'>cmd</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_gh_executable'>gh_executable</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attestation</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>verify</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_bottle'>bottle</span><span class='period'>.</span><span class='id identifier rubyid_cached_download'>cached_download</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--repo</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_signing_repo'>signing_repo</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--format</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
         <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>json</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>

  <span class='id identifier rubyid_cmd'>cmd</span> <span class='op'>+=</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--cert-identity</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_signing_workflow'>signing_workflow</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_signing_workflow'>signing_workflow</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>

  <span class='comment'># Fail early if we have no credentials. The command below invariably
</span>  <span class='comment'># fails without them, so this saves us a network roundtrip before
</span>  <span class='comment'># presenting the user with the same error.
</span>  <span class='id identifier rubyid_credentials'>credentials</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../GitHub.html" title="GitHub (module)">GitHub</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../GitHub/API.html" title="GitHub::API (module)">API</a></span></span><span class='period'>.</span><span class='id identifier rubyid_credentials'><span class='object_link'><a href="../GitHub/API.html#credentials-class_method" title="GitHub::API.credentials (method)">credentials</a></span></span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="Attestation/GhAuthNeeded.html" title="Homebrew::Attestation::GhAuthNeeded (class)">GhAuthNeeded</a></span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>missing credentials</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_credentials'>credentials</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>

  <span class='kw'>begin</span>
    <span class='id identifier rubyid_output'>output</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Utils.html" title="Utils (module)">Utils</a></span></span><span class='period'>.</span><span class='id identifier rubyid_safe_popen_read'><span class='object_link'><a href="../Utils.html#safe_popen_read-class_method" title="Utils.safe_popen_read (method)">safe_popen_read</a></span></span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>GH_TOKEN</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_credentials'>credentials</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_cmd'>cmd</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="../ErrorDuringExecution.html" title="ErrorDuringExecution (class)">ErrorDuringExecution</a></span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='comment'># Even if we have credentials, they may be invalid or malformed.
</span>    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="Attestation/GhAuthNeeded.html" title="Homebrew::Attestation::GhAuthNeeded (class)">GhAuthNeeded</a></span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>invalid credentials</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span><span class='period'>.</span><span class='id identifier rubyid_exitstatus'>exitstatus</span> <span class='op'>==</span> <span class='int'>4</span>

    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="Attestation/InvalidAttestationError.html" title="Homebrew::Attestation::InvalidAttestationError (class)">InvalidAttestationError</a></span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attestation verification failed: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>begin</span>
    <span class='id identifier rubyid_attestations'>attestations</span> <span class='op'>=</span> <span class='const'>JSON</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_output'>output</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='const'>JSON</span><span class='op'>::</span><span class='const'>ParserError</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="Attestation/InvalidAttestationError.html" title="Homebrew::Attestation::InvalidAttestationError (class)">InvalidAttestationError</a></span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attestation verification returned malformed JSON</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># `gh attestation verify` returns a JSON array of one or more results,
</span>  <span class='comment'># for all attestations that match the input&#39;s digest. We want to additionally
</span>  <span class='comment'># filter these down to just the attestation whose subject matches the bottle&#39;s name.
</span>  <span class='id identifier rubyid_subject'>subject</span> <span class='op'>=</span> <span class='id identifier rubyid_bottle'>bottle</span><span class='period'>.</span><span class='id identifier rubyid_filename'>filename</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='kw'>if</span> <span class='id identifier rubyid_subject'>subject</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
  <span class='id identifier rubyid_attestation'>attestation</span> <span class='op'>=</span> <span class='id identifier rubyid_attestations'>attestations</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='op'>|</span>
    <span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_dig'>dig</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>verificationResult</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>statement</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>subject</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>0</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>name</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>==</span> <span class='id identifier rubyid_subject'>subject</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="Attestation/InvalidAttestationError.html" title="Homebrew::Attestation::InvalidAttestationError (class)">InvalidAttestationError</a></span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>no attestation matches subject</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_attestation'>attestation</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>

  <span class='id identifier rubyid_attestation'>attestation</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="check_core_attestation-class_method">
  
    .<strong>check_core_attestation</strong>(bottle)  &#x21d2; <tt><span class='object_link'><a href="../Hash.html" title="Hash (class)">Hash</a></span>{<span class='object_link'>T</span>.untyped =&gt; <span class='object_link'>T</span>.untyped}</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  This method may only be used in the <a href="https://github.com/Homebrew/brew">Homebrew/brew</a> repository.
  Third parties should avoid using this method if possible, as it may be removed or changed without warning.
</p>
<p>Verifies the given bottle against a cryptographic attestation of build provenance
from homebrew-core&#39;s CI, falling back on a &quot;backfill&quot; attestation for older bottles.</p>

<p>This is a specialization of <code>check_attestation</code> for homebrew-core.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>bottle</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Bottle.html" title="Bottle (class)">Bottle</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Hash.html" title="Hash (class)">Hash</a></span>{<span class='object_link'>T</span>.untyped =&gt; <span class='object_link'>T</span>.untyped}</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>the JSON-decoded response</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Attestation/GhAuthNeeded.html" title="Homebrew::Attestation::GhAuthNeeded (class)">GhAuthNeeded</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>on any authentication failures</p>
</div>
      
    </li>
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Attestation/InvalidAttestationError.html" title="Homebrew::Attestation::InvalidAttestationError (class)">InvalidAttestationError</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>on any verification failures</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'attestation.rb', line 124</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_check_core_attestation'>check_core_attestation</span><span class='lparen'>(</span><span class='id identifier rubyid_bottle'>bottle</span><span class='rparen'>)</span>
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_attestation'>attestation</span> <span class='op'>=</span> <span class='id identifier rubyid_check_attestation'>check_attestation</span> <span class='id identifier rubyid_bottle'>bottle</span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="#HOMEBREW_CORE_REPO-constant" title="Homebrew::Attestation::HOMEBREW_CORE_REPO (constant)">HOMEBREW_CORE_REPO</a></span></span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="#HOMEBREW_CORE_CI_URI-constant" title="Homebrew::Attestation::HOMEBREW_CORE_CI_URI (constant)">HOMEBREW_CORE_CI_URI</a></span></span>
    <span class='kw'>return</span> <span class='id identifier rubyid_attestation'>attestation</span>
  <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="Attestation/InvalidAttestationError.html" title="Homebrew::Attestation::InvalidAttestationError (class)">InvalidAttestationError</a></span></span>
    <span class='id identifier rubyid_odebug'>odebug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>falling back on backfilled attestation for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_bottle'>bottle</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>

    <span class='comment'># Our backfilled attestation is a little unique: the subject is not just the bottle
</span>    <span class='comment'># filename, but also has the bottle&#39;s hosted URL hash prepended to it.
</span>    <span class='comment'># This was originally unintentional, but has a virtuous side effect of further
</span>    <span class='comment'># limiting domain separation on the backfilled signatures (by committing them to
</span>    <span class='comment'># their original bottle URLs).
</span>    <span class='id identifier rubyid_url_sha256'>url_sha256</span> <span class='op'>=</span> <span class='const'>Digest</span><span class='op'>::</span><span class='const'>SHA256</span><span class='period'>.</span><span class='id identifier rubyid_hexdigest'>hexdigest</span><span class='lparen'>(</span><span class='id identifier rubyid_bottle'>bottle</span><span class='period'>.</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_subject'>subject</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_url_sha256'>url_sha256</span><span class='embexpr_end'>}</span><span class='tstring_content'>--</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_bottle'>bottle</span><span class='period'>.</span><span class='id identifier rubyid_filename'>filename</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>

    <span class='comment'># We don&#39;t pass in a signing workflow for backfill signatures because
</span>    <span class='comment'># some backfilled bottle signatures were signed from the &#39;backfill&#39;
</span>    <span class='comment'># branch, and others from &#39;main&#39; of trailofbits/homebrew-brew-verify
</span>    <span class='comment'># so the signing workflow is slightly different which causes some bottles to incorrectly
</span>    <span class='comment'># fail when checking their attestation. This shouldn&#39;t meaningfully affect security
</span>    <span class='comment'># because if somehow someone could generate false backfill attestations
</span>    <span class='comment'># from a different workflow we will still catch it because the
</span>    <span class='comment'># attestation would have been generated after our cutoff date.
</span>    <span class='id identifier rubyid_backfill_attestation'>backfill_attestation</span> <span class='op'>=</span> <span class='id identifier rubyid_check_attestation'>check_attestation</span> <span class='id identifier rubyid_bottle'>bottle</span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="#BACKFILL_REPO-constant" title="Homebrew::Attestation::BACKFILL_REPO (constant)">BACKFILL_REPO</a></span></span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_subject'>subject</span>
    <span class='id identifier rubyid_timestamp'>timestamp</span> <span class='op'>=</span> <span class='id identifier rubyid_backfill_attestation'>backfill_attestation</span><span class='period'>.</span><span class='id identifier rubyid_dig'>dig</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>verificationResult</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>verifiedTimestamps</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                                         <span class='int'>0</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>timestamp</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="Attestation/InvalidAttestationError.html" title="Homebrew::Attestation::InvalidAttestationError (class)">InvalidAttestationError</a></span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>backfill attestation is missing verified timestamp</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_timestamp'>timestamp</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>

    <span class='kw'>if</span> <span class='const'>DateTime</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_timestamp'>timestamp</span><span class='rparen'>)</span> <span class='op'>&gt;</span> <span class='const'><span class='object_link'><a href="#BACKFILL_CUTOFF-constant" title="Homebrew::Attestation::BACKFILL_CUTOFF (constant)">BACKFILL_CUTOFF</a></span></span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="Attestation/InvalidAttestationError.html" title="Homebrew::Attestation::InvalidAttestationError (class)">InvalidAttestationError</a></span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>backfill attestation post-dates cutoff</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_backfill_attestation'>backfill_attestation</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="gh_executable-class_method">
  
    .<strong>gh_executable</strong>  &#x21d2; <tt><span class='object_link'><a href="../Pathname.html" title="Pathname (class)">Pathname</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  This method may only be used in the <a href="https://github.com/Homebrew/brew">Homebrew/brew</a> repository.
  Third parties should avoid using this method if possible, as it may be removed or changed without warning.
</p>
<p>Returns a path to a suitable <code>gh</code> executable for attestation verification.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Pathname.html" title="Pathname (class)">Pathname</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


46
47
48
49
50
51
52
53</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'attestation.rb', line 46</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_gh_executable'>gh_executable</span>
  <span class='comment'># NOTE: We disable HOMEBREW_VERIFY_ATTESTATIONS when installing `gh` itself,
</span>  <span class='comment'>#       to prevent a cycle during bootstrapping. This can eventually be resolved
</span>  <span class='comment'>#       by vendoring a pure-Ruby Sigstore verifier client.
</span>  <span class='ivar'>@gh_executable</span> <span class='op'>||=</span> <span class='const'>T</span><span class='period'>.</span><span class='id identifier rubyid_let'>let</span><span class='lparen'>(</span><span class='id identifier rubyid_with_env'>with_env</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>HOMEBREW_VERIFY_ATTESTATIONS</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='kw'>nil</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_ensure_executable!'>ensure_executable!</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>gh</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span><span class='comma'>,</span> <span class='const'>T</span><span class='period'>.</span><span class='id identifier rubyid_nilable'>nilable</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../Pathname.html" title="Pathname (class)">Pathname</a></span></span><span class='rparen'>)</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
     Generated by <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>.
</div>

    </div>
  </body>
</html>